<template>
  <oxd-card-table-container>
    <oxd-card-thead>
      <oxd-card-tr>
        <oxd-card-th
          v-if="selectable"
          class="oxd-padding-cell oxd-table-th"
          :class="selector.class"
          :style="selector.style"
        >
          <input
            type="checkbox"
            v-model="selectedAll"
            @change="onChangeSelectAll"
          />
        </oxd-card-th>

        <oxd-card-th
          class="oxd-padding-cell oxd-table-th"
          v-for="header in headers"
          :key="header"
          :style="header.style"
          :class="header.class"
        >
          {{ header.title }}
        </oxd-card-th>
      </oxd-card-tr>
    </oxd-card-thead>

    <oxd-card-tbody>
      <component
        :is="rowDecorator"
        v-for="(item, index) in items"
        :key="item"
        :clickable="clickable"
        @click="onClick(item)($event)"
        :rowItem="item"
      >
        <oxd-card-tr>
          <oxd-card-td
            v-if="selectable"
            class="oxd-padding-cell"
            :class="selector.class"
            :style="selector.style"
          >
            <input
              type="checkbox"
              :value="index"
              v-model="checkedItems"
              @click="onClickCheckbox(item, $event)"
            />
          </oxd-card-td>

          <oxd-card-td
            class="oxd-padding-cell"
            v-for="header in headers"
            :key="header"
            :style="header.style"
            :class="header.class"
          >
            <component
              :is="header.cellType ? header.cellType : 'oxd-table-cell-default'"
              :item="item[header.name]"
              :rowItem="item"
              :header="header"
            />
          </oxd-card-td>
        </oxd-card-tr>
      </component>
    </oxd-card-tbody>
  </oxd-card-table-container>
</template>

<script lang="ts">
import {
  defineComponent,
  PropType,
  computed,
  reactive,
  watch,
  toRefs,
} from 'vue';
import {CardSelector, CardHeaders} from './types';
import Table from '@orangehrm/oxd/core/components/CardTable/Table.vue';
import TableHeader from '@orangehrm/oxd/core/components/CardTable/TableHeader.vue';
import TableBody from '@orangehrm/oxd/core/components/CardTable/TableBody.vue';
import TableRow from '@orangehrm/oxd/core/components/CardTable/TableRow.vue';
import TableHeaderCell from '@orangehrm/oxd/core/components/CardTable/TableHeaderCell.vue';
import TableDataCell from '@orangehrm/oxd/core/components/CardTable/TableDataCell.vue';

// Decorators
import DefaultDecorator from '@orangehrm/oxd/core/components/CardTable/Decorator/Default.vue';
import CardDecorator from '@orangehrm/oxd/core/components/CardTable/Decorator/Card.vue';

// Cells
import DefaultCell from '@orangehrm/oxd/core/components/CardTable/Cell/Default.vue';
import ActionsCell from '@orangehrm/oxd/core/components/CardTable/Cell/Actions.vue';

interface State {
  checkedItems: number[];
  selectedAll: boolean;
}

export default defineComponent({
  name: 'oxd-card-card-table',

  props: {
    selector: {
      type: Object as PropType<CardSelector>,
      default: () => ({}),
    },
    headers: {
      type: Array as PropType<CardHeaders>,
      default: () => [],
    },
    items: {
      type: Array,
      default: () => [],
    },
    clickable: {
      type: Boolean,
      default: true,
    },
    selectable: {
      type: Boolean,
      default: false,
    },
    selected: {
      type: Array as PropType<number[]>,
      default: () => [],
    },
    rowDecorator: {
      type: String,
      default: 'oxd-table-decorator-default',
    },
  },

  setup(props, context) {
    const state: State = reactive({
      checkedItems: props.selected,
      selectedAll:
        props.selected.length > 0 &&
        props.selected.length === props.items.length,
    });

    watch(
      () => state.checkedItems,
      function(newVal) {
        state.selectedAll =
          newVal.length === props.items.length && props.items.length != 0;
        context.emit('update:selected', newVal);
      },
    );

    return {
      ...toRefs(state),
    };
  },

  provide() {
    return {
      tableProps: computed(() => this.$props),
    };
  },

  emits: ['click', 'clickCheckbox', 'update:selected', 'update:selectAll'],

  components: {
    'oxd-card-table-container': Table,
    'oxd-card-thead': TableHeader,
    'oxd-card-tbody': TableBody,
    'oxd-card-tr': TableRow,
    'oxd-card-th': TableHeaderCell,
    'oxd-card-td': TableDataCell,

    // Decorators
    'oxd-table-decorator-default': DefaultDecorator,
    'oxd-table-decorator-card': CardDecorator,

    // Cells
    'oxd-table-cell-default': DefaultCell,
    'oxd-table-cell-actions': ActionsCell,
  },

  methods: {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    onClick(item: any) {
      return (e: Event) => {
        this.$emit('click', {item, native: e});
      };
    },
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    onClickCheckbox(item: any, e: Event) {
      e.stopPropagation();
      this.$emit('clickCheckbox', {item, native: e});
    },
    onChangeSelectAll() {
      this.checkedItems = this.selectedAll
        ? [...this.range(0, this.items.length - 1)]
        : [];
      this.$emit('update:selectAll', this.selectedAll);
    },
    range(from: number, to: number): Array<number> {
      const range = [];
      if (from > to) {
        // eslint-disable-next-line no-console
        console.error('`from` is bigger than `to`');
      }
      for (let i = from; i <= to; i++) {
        range.push(i);
      }
      return range;
    },
  },
});
</script>

<style src="./card-table.scss" lang="scss" scoped></style>
